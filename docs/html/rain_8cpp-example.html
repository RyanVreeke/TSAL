<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TSAL: rain.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TSAL
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">A thread safe audio library for audiolizing code execution</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">rain.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>One use of multithreaded is to speed up the processing of data. However, in the case of audio, processing a song at twice the speed doesn't really make sense. As a result, this example was created as the next best thing. To make use of the speed up from multithreading, this example parses MIDI files that store the entire song on one track. When processed with a single ThreadSynth, the song will play its parts separately. But when processed with the right number of threads. The ThreadSynths will be playing in unison, and the song will be completed properly.</p>
<p>Parse the parameters<br  />
Create the mixer and synths<br  />
Play the song through once with only one thread<br  />
Run parallel block</p><ul>
<li>Calculate a time offset so the later notes get scheduled at the right time</li>
<li>Play the midi events</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;tsal.hpp&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;MidiFile.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;omp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">  <span class="keywordflow">if</span> (argc != 3) {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Invalid arguments\n\n&quot;</span></div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;rain &lt;midifile&gt; &lt;tracks&gt;\n&quot;</span> </div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;\tmidifile = a path to a midifile\n&quot;</span> </div>
<div class="line">              &lt;&lt; <span class="stringliteral">&quot;\ttracks = the number of tracks in the midifile\n&quot;</span></div>
<div class="line">              &lt;&lt; std::endl;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> numTracks = atoi(argv[2]);</div>
<div class="line">  <a name="_a0"></a><a class="code" href="classtsal_1_1MidiParser.html">tsal::MidiParser</a> midiParser(numTracks, argv[1]);</div>
<div class="line"> </div>
<div class="line">  <a name="_a1"></a><a class="code" href="classtsal_1_1Mixer.html">tsal::Mixer</a> mixer;</div>
<div class="line">  std::vector&lt;tsal::ThreadSynth&gt; voices(numTracks, <a name="_a2"></a><a class="code" href="classtsal_1_1ThreadSynth.html">tsal::ThreadSynth</a>(&amp;mixer));  </div>
<div class="line"> </div>
<div class="line">  omp_set_num_threads(numTracks);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">  #pragma omp parallel</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">int</span> <span class="keywordtype">id</span> = omp_get_thread_num();</div>
<div class="line">    mixer.<a name="a3"></a><a class="code" href="classtsal_1_1Mixer.html#a57356305ff06ef0a5ad4d53ef63d9649">add</a>(voices[<span class="keywordtype">id</span>]);</div>
<div class="line">    voices[id].setVolume(0.3);</div>
<div class="line">    voices[id].setEnvelope(0, 0, 1, 2.0);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">int</span> timeOffset = midiParser[<span class="keywordtype">id</span> * std::floor(midiParser.<a name="a4"></a>size()/omp_get_num_threads())].tick;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    #pragma omp for</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; midiParser.size(); i++) {</div>
<div class="line">      <span class="keyword">auto</span>&amp; me = midiParser[i];  </div>
<div class="line">      <span class="keywordflow">if</span> (me.isNoteOn())</div>
<div class="line">        voices[id].play(me.getKeyNumber(), tsal::Sequencer::TICK, me.tick - timeOffset);</div>
<div class="line">      </div>
<div class="line">      <span class="keywordflow">if</span> (me.isNoteOff())</div>
<div class="line">        voices[id].stop(tsal::Sequencer::TICK, me.tick - timeOffset);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="aclasstsal_1_1ThreadSynth_html"><div class="ttname"><a href="classtsal_1_1ThreadSynth.html">tsal::ThreadSynth</a></div><div class="ttdoc">A threaded audio synthesizer.</div><div class="ttdef"><b>Definition:</b> ThreadSynth.hpp:18</div></div>
<div class="ttc" id="aclasstsal_1_1MidiParser_html"><div class="ttname"><a href="classtsal_1_1MidiParser.html">tsal::MidiParser</a></div><div class="ttdoc">Parse a midi file for the sake of multithreading playing.</div><div class="ttdef"><b>Definition:</b> MidiParser.hpp:23</div></div>
<div class="ttc" id="aclasstsal_1_1Mixer_html_a57356305ff06ef0a5ad4d53ef63d9649"><div class="ttname"><a href="classtsal_1_1Mixer.html#a57356305ff06ef0a5ad4d53ef63d9649">tsal::Mixer::add</a></div><div class="ttdeci">void add(Channel &amp;channel)</div><div class="ttdoc">Add a channel.</div><div class="ttdef"><b>Definition:</b> Mixer.cpp:128</div></div>
<div class="ttc" id="aclasstsal_1_1Mixer_html"><div class="ttname"><a href="classtsal_1_1Mixer.html">tsal::Mixer</a></div><div class="ttdoc">The main audio manager that handles the overhead of audio buffers and channel mixing.</div><div class="ttdef"><b>Definition:</b> Mixer.hpp:19</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
